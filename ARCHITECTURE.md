# Architecture

> Generated by /map on 2026-01-19
> Governance: .agent/rules/tabletop.md

## Overview
Tabletop Scheduler is a Next.js 14 application designed to coordinate tabletop game sessions. It strictly adheres to **Feature Sliced Design (FSD)** for the frontend and **Vertical Sliced Architecture (VSA)** for the backend.

The system operates in two distinct modes:
1.  **Hosted Mode** (SaaS): Maximizes AEO/SEO/GEO visibility. Uses Supabase (Postgres).
2.  **Self-Hosted Mode** (Docker): Maximizes Privacy (No-Index). Uses SQLite.

## System Diagram
```mermaid
graph TD
    User[User/Participant] -->|Web Browser| NextApp[Next.js App]
    Telegram[Telegram Bot] -->|Webhook/LongPoll| NextApp
    Discord[Discord Bot] -->|Webhook| NextApp
    
    subgraph "Next.js Application"
        UI[React UI (App Router)]
        API[API Routes /api/*]
        Actions[Server Actions]
    end
    
    NextApp -->|Reads/Writes| DB[(Database)]
    
    UI --> Actions
    UI --> API
    
    Actions -->|ORM| DB
    API -->|ORM| DB
    
    subgraph "Data Persistence"
        direction TB
        SQLite[(SQLite - SelfHosted)]
        Postgres[(Supabase - Hosted)]
    end
    
    DB -.-> SQLite
    DB -.-> Postgres
```

## Architectural Standards

### Frontend: Feature Sliced Design (FSD)
- **Layers:** `app` -> `processes` -> `pages` -> `widgets` -> `features` -> `entities` -> `shared`.
- **Slices:** Group code by **business domain** (e.g., `features/voting`), not technical function.

### Backend: Vertical Sliced Architecture (VSA)
- **Organization:** Code is organized by **Feature** (e.g., `Features/CreateOrder`).
- **Isolation:** Each vertical slice is self-contained.
- **CQRS:** Command/Query separation encouraged within slices.

### Dual-Bot Consistency
Any logic change to Telegram command handling must be applied to **BOTH**:
- `app/api/telegram/webhook/route.ts` (Production/Webhook)
- `lib/telegram-poller.ts` (Dev/Long-Polling)

## Components

### Core Application
- **Purpose:** Next.js App Router application handling UI, Routing, and API.
- **Location:** `app/`
- **Key Routes:**
  - `/`: Landing Page (Adapts content based on `NEXT_PUBLIC_IS_HOSTED`)
  - `/new`: Event Creation Wizard
  - `/e/[slug]`: Event Dashboard
  - `/api/event`: Integration endpoints

### Database Layer
- **Schema:** 
  - `prisma/schema.prisma` (SQLite/Self-Hosted)
  - `prisma/schema.hosted.prisma` (Postgres/Supabase/Hosted)
- **Models:** `Event`, `TimeSlot`, `Participant`, `Vote`, `WebhookEvent`, `LoginToken`.

### Server Actions (`app/actions.ts`)
- **Role:** Encapsulate business logic.
- **Governance:** Must handle environment differences (Hosted vs Self) gracefully.

## Integration Points
| External Service | Type | Purpose | Mode Validity |
|------------------|------|---------|---------------|
| Telegram API | API | Bot interactions, notifications. | Global |
| Discord API | API | Channel updates, notifications. | Global |
| Supabase | DB | Primary Store for Hosted Mode. | Hosted Only |
| Local Filesystem | DB | SQLite storage. | Self-Hosted Only |

## AEO/SEO/GEO Strategy
- **Hosted:** Full Indexing. Rich Schema (`SoftwareApplication`, `FAQPage`, `HowTo`).
- **Self-Hosted:** `noindex, nofollow`. Privacy First.

## Technical Debt & Compliance
- [ ] Ensure FSD layer violations are resolved (e.g., `components` folder usage vs `features/entities`).
- [ ] Verify `app/actions.ts` adheres to VSA (currently monolithic).
- [ ] Confirm strict separation of Hosted vs Self-Hosted schemas.
